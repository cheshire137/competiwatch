<% content_for(:title, 'Admin') %>

<div class="blankslate clearfix mb-4 p-3">
  <div class="col-md-4 float-left">
    <ul class="list-style-none">
      <li>
        <strong><%= number_with_delimiter @users.total_entries %></strong>
        <%= 'user'.pluralize(@users.total_entries) %>
      </li>
      <li>
        <strong><%= number_with_delimiter @oauth_account_count %></strong>
        <%= 'account'.pluralize(@oauth_account_count) %>
      </li>
    </ul>
  </div>
  <div class="col-md-4 float-left">
    <ul class="list-style-none">
      <li>
        <strong><%= number_with_delimiter @friend_count %></strong>
        <%= 'friend'.pluralize(@friend_count) %>
      </li>
      <li>
        <strong><%= number_with_delimiter @match_count %></strong>
        <%= 'match'.pluralize(@match_count) %>
      </li>
    </ul>
  </div>
  <div class="col-md-4 float-left">
    <ul class="list-style-none">
      <li>
        <strong><%= number_with_delimiter @season_share_count %></strong>
        <%= 'shared season'.pluralize(@season_share_count) %>
      </li>
    </ul>
  </div>
</div>

<div class="clearfix mb-4">
  <div class="col-md-6 float-left">
    <h2 class="h2">Users</h2>
    <ul class="list-style-none mb-4">
      <% @users.each_with_index do |user, i| %>
        <%
          accounts_for_user = @oauth_accounts_by_user_id[user.id] || []
          friend_count = (@friends_by_user_id[user.id] || []).size
        %>
        <li class="<%= 'border-top mt-2 pt-2' if i > 0 %>">
          <h3 class="h4">
            <%= user %>
            <span class="text-gray h5 text-normal">
              &mdash;
              <%= number_with_delimiter friend_count %>
              <%= 'friend'.pluralize(friend_count) %>
            </span>
          </h3>
          <ol class="oauth-accounts-list">
            <% if accounts_for_user.empty? %>
              <li>
                <em>No accounts</em>
              </li>
            <% end %>
            <% accounts_for_user.each do |oauth_account| %>
              <%
                account_matches = @matches_by_oauth_account_id[oauth_account.id] || []
                match_count = account_matches.size
                details_class = if match_count > 0
                  "account-#{oauth_account.id}"
                end
              %>
              <li>
                <button type="button" class="text-gray-dark btn-link <% if details_class %>js-toggle-details<% end %>" <% if details_class %>data-target=".<%= details_class %>"<% else %>disabled<% end %>>
                  <%= oauth_account %>
                  &mdash;
                  <%= number_with_delimiter match_count %>
                  <%= 'match'.pluralize(match_count) %>
                </button>

                <div class="<%= details_class %> d-none d-flex-md flex-wrap flex-justify-between-md">
                  <% @seasons.each do |season| %>
                    <% season_match_count = account_matches.select { |match| match.season == season.number }.size %>
                    <div class="mb-1 account-season">
                      <span class="text-bold">Season <%= season %></span> &mdash;
                      <%= number_with_delimiter season_match_count %>
                      <%= 'match'.pluralize(season_match_count) %>
                    </div>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ol>
        </li>
      <% end %>
    </ul>

    <% if @users.total_pages > 1 %>
      <div class="my-4">
        <%= page_entries_info @users %>
        <%= will_paginate @users, page_links: false %>
      </div>
    <% end %>
  </div>

  <div class="col-md-6 float-left">
    <h2 class="h2">Seasons</h2>
    <ul class="list-style-none">
      <% @seasons.each_with_index do |season, i| %>
        <li class="<%= 'border-top mt-2 pt-2' if i > 0 %>">
          <button type="button" class="btn-link d-flex flex-justify-between width-full js-toggle-details" data-target=".season-<%= season %>">
            <strong>Season <%= season %></strong>
            <span class="text-gray">
              <% if season.started_on %>
                <%= pretty_date season.started_on %>
              <% end %>
              <% if season.started_on && season.ended_on %>
                &mdash;
              <% end %>
              <% if season.ended_on %>
                <% unless season.started_on %>
                  Ends
                <% end %>
                <%= pretty_date season.ended_on %>
              <% end %>
            </span>
          </button>
          <div class="d-none border rounded-2 px-2 pb-2 mt-2 season-<%= season %>">
            <%= form_for(season, url: admin_update_season_path, method: :put, as: :update_season) do |form| %>
              <input type="hidden" name="season_id" value="<%= season.id %>">
              <div class="form-group">
                <%= form.label :started_on, 'Start date:', class: 'mr-2' %>
                <%= form.date_field :started_on, class: 'form-control' %>
              </div>
              <div class="form-group">
                <%= form.label :ended_on, 'End date:', class: 'mr-2' %>
                <%= form.date_field :ended_on, class: 'form-control' %>
              </div>
              <div class="form-group">
                <%= form.label :max_rank, 'Max rank:', class: 'mr-2' %>
                <%= form.number_field :max_rank, min: 0, step: 1, class: 'form-control' %>
              </div>
              <button type="submit" class="btn">
                Save season <%= season %>
              </button>
            <% end %>

            <%= form_for(season, url: admin_destroy_season_path, method: :delete, html: { class: 'mt-2 pt-2 border-top text-right' }) do |form| %>
              <input type="hidden" name="season_id" value="<%= season.id %>">
              <button type="submit" class="btn-sm btn btn-danger" data-confirm="Are you sure you want to delete season <%= season %>?">
                Delete season <%= season %>
              </button>
            <% end %>
          </div>
        </li>
      <% end %>
    </ul>

    <button class="btn-link mt-2 width-full text-left border-top pt-2 js-toggle-details" data-target=".new-season" type="button">
      <span class="ion ion-plus"></span>
      Add a season
    </button>

    <div class="d-none border rounded-2 px-2 pb-2 mt-2 new-season">
      <%= form_for(@new_season, url: admin_create_season_path, as: :create_season) do |form| %>
        <div class="form-group">
          <%= form.label :number, 'Number:', class: 'mr-2' %>
          <%= form.number_field :number, min: 0, step: 1, class: 'form-control' %>
        </div>
        <div class="form-group">
          <%= form.label :started_on, 'Start date:', class: 'mr-2' %>
          <%= form.date_field :started_on, class: 'form-control' %>
        </div>
        <div class="form-group">
          <%= form.label :ended_on, 'End date:', class: 'mr-2' %>
          <%= form.date_field :ended_on, class: 'form-control' %>
        </div>
        <div class="form-group">
          <%= form.label :max_rank, 'Max rank:', class: 'mr-2' %>
          <%= form.number_field :max_rank, min: 0, step: 1, class: 'form-control' %>
        </div>
        <button type="submit" class="btn">
          Save season
        </button>
      <% end %>
    </div>
  </div>
</div>

<% if @userless_accounts.any? %>
  <hr>

  <h2 class="h2">Accounts without users</h2>
  <ul class="list-style-none">
    <% @userless_accounts.each do |oauth_account| %>
      <li><%= oauth_account %></li>
    <% end %>
  </ul>
<% end %>

<hr>

<div class="mt-4 clearfix">
  <% if @users.size > 1 %>
    <div class="col-md-6 mb-4 float-left">
      <div class="border border-red p-3 rounded-2">
        <h2 class="h2">Merge users</h2>
        <%= form_tag admin_merge_users_path do %>
          <div class="form-group">
            <label for="primary_user_id">Primary user:</label>
            <%= select_tag :primary_user_id, options_for_select(@user_options), class: 'form-select', required: true %>
            <p class="note">
              This user will be kept.
            </p>
          </div>
          <div class="form-group">
            <label for="secondary_user_id">Secondary user:</label>
            <%= select_tag :secondary_user_id, options_for_select(@user_options), class: 'form-select', required: true %>
            <p class="note">
              This user will be deleted.
            </p>
          </div>
          <button type="submit" class="btn btn-danger" data-confirm="Are you sure you want to combine these users?">
            Combine users
          </button>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @userless_accounts.any? %>
    <div class="col-md-6 mb-4 float-left">
      <div class="border border-red p-3 rounded-2">
        <h2 class="h2">Tie account to a user</h2>
        <%= form_tag admin_update_account_path do %>
          <div class="form-group">
            <label for="user_id">User:</label>
            <%= select_tag :user_id, options_for_select(@user_options), class: 'form-select', required: true %>
          </div>
          <div class="form-group">
            <label for="oauth_account_id">Account:</label>
            <%= select_tag :oauth_account_id, options_for_select(@userless_account_options), class: 'form-select', required: true %>
          </div>
          <button type="submit" class="btn btn-danger" data-confirm="Are you sure you want to connect the account to the user?">
            Connect account to user
          </button>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
